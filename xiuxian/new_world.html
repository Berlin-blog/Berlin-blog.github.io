<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®çœŸä¸–ç•Œ</title>
    <style>
        :root {
            --primary-color: #c0a0f0;
            --secondary-color: #f0d090;
            --bg-color: #0a0a1a;
            --panel-bg: rgba(15, 10, 25, 0.8);
            --text-color: #e0d0b0;
            --danger-color: #ff6060;
            --success-color: #60ff80;
            --warning-color: #ffd060;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'SimSun', 'å®‹ä½“', serif;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            position: relative;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at 20% 50%, #1a1a3a, var(--bg-color));
            position: relative;
            overflow: hidden;
        }

        .game-header {
            padding: 15px 20px;
            background: rgba(10, 5, 20, 0.7);
            border-bottom: 1px solid #3a2a5a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            box-shadow: 0 0 15px rgba(100, 60, 180, 0.3);
        }

        .game-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-shadow: 0 0 10px #8060c0;
            animation: title-glow 10s infinite alternate;
        }

        @keyframes title-glow {
            0% { color: var(--primary-color); }
            100% { color: var(--secondary-color); }
        }

        .player-info {
            display: flex;
            gap: 20px;
        }

        .player-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 18px;
            color: var(--secondary-color);
        }

        .stat-label {
            font-size: 12px;
            color: #a09070;
        }

        .game-content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .scene-container {
            flex: 3;
            position: relative;
            overflow: hidden;
        }

        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .narrative-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background:
                linear-gradient(to bottom, rgba(10, 5, 20, 0.9), rgba(26, 26, 58, 0.9)),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><rect width="100" height="100" fill="none" stroke="%238060c0" stroke-width="2"/><path d="M0,0 L100,100" stroke="%238060c0" stroke-width="1"/><path d="M100,0 L0,100" stroke="%238060c0" stroke-width="1"/></svg>');
            border-top: 2px solid;
            border-image: linear-gradient(to right, #8060c0, var(--primary-color)) 1;
            padding: 20px;
            z-index: 6;
            pointer-events: auto;
            border-radius: 8px 8px 0 0;
        }

        .narrative-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
            min-height: 80px;
            color: var(--text-color);
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .choice-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .choice-btn {
            background: linear-gradient(to bottom, #3a2a5a, #5a4a8a);
            border: 1px solid #8060c0;
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .choice-btn:hover {
            background: linear-gradient(to bottom, #4a3a6a, #6a5a9a);
            box-shadow: 0 0 15px rgba(120, 80, 200, 0.7);
            transform: scale(1.05);
        }

        .choice-btn:active {
            transform: scale(0.98);
        }

        .action-panel {
            flex: 1;
            background:
                linear-gradient(to bottom, var(--panel-bg), rgba(26, 20, 40, 0.8)),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="none" stroke="%23c0a0f0" stroke-width="1"/></svg>');
            border-left: 2px solid;
            border-image: linear-gradient(to bottom, #8060c0, var(--primary-color)) 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 300px;
            z-index: 10;
            border-radius: 0 0 0 8px;
        }

        .panel-title {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 10px;
            border-bottom: 1px solid #3a2a5a;
            padding-bottom: 5px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-btn {
            background: linear-gradient(to right, #3a2a5a, #4a3a6a);
            border: 1px solid #5a4a8a;
            color: var(--text-color);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .action-btn:hover {
            background: linear-gradient(to right, #4a3a6a, #5a4a8a);
            transform: translateX(5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .action-btn:active {
            transform: translateX(5px) scale(0.98);
        }

        .action-btn.new-feature::after {
            content: "";
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: var(--danger-color);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .status-panel {
            background: rgba(20, 15, 35, 0.7);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #4a3a7a;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            align-items: center;
        }

        .status-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            display: inline-block;
        }

        .progress-bar {
            height: 8px;
            background: rgba(40, 30, 60, 0.7);
            border-radius: 4px;
            margin-top: 3px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
            position: relative;
        }

        .health-bar .progress-fill {
            background: linear-gradient(to right, #f08080, var(--danger-color));
        }

        .mana-bar .progress-fill {
            background: linear-gradient(to right, #80a0f0, #6080ff);
        }

        .cultivation-bar .progress-fill {
            background: linear-gradient(to right, #f0d080, var(--warning-color));
        }

        .progress-glow {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            animation: glow-move 2s infinite linear;
            opacity: 0.7;
        }

        @keyframes glow-move {
            0% { left: -20px; }
            100% { left: 100%; }
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .loading-text {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 20px;
            overflow: hidden;
            border-right: 2px solid var(--primary-color);
            white-space: nowrap;
            animation: typing 3s steps(20, end), blink-caret 0.75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 240px; }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: var(--primary-color); }
        }

        .loading-bar {
            width: 300px;
            height: 10px;
            background: rgba(40, 30, 60, 0.7);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #8060c0, var(--primary-color));
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s;
        }

        .popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 80%;
            max-width: 800px;
            background: rgba(15, 10, 30, 0.95);
            border: 2px solid #8060c0;
            border-radius: 10px;
            padding: 30px;
            z-index: 20;
            box-shadow: 0 0 30px rgba(100, 60, 180, 0.5);
            display: none;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }

        .popup.active {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .popup-title {
            font-size: 24px;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .popup-content {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .section-title {
            font-size: 18px;
            color: var(--secondary-color);
            margin-bottom: 10px;
            border-bottom: 1px solid #3a2a5a;
            padding-bottom: 5px;
        }

        .close-popup {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
        }

        .floating-text {
            position: absolute;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            z-index: 4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .floating-text.health {
            color: var(--danger-color);
        }

        .floating-text.mana {
            color: #6080ff;
        }

        .floating-text.cultivation {
            color: var(--warning-color);
        }

        .floating-text.talent {
            color: #a0ffa0;
        }

        .floating-text.luck {
            color: #ffd700;
        }

        .floating-text.dao {
            color: var(--primary-color);
        }

        .spiritual-root-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .spiritual-root-option {
            padding: 15px;
            text-align: center;
            background: rgba(40, 30, 70, 0.7);
            border: 2px solid #5a4a8a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .spiritual-root-option:hover {
            background: rgba(60, 50, 100, 0.9);
            transform: scale(1.05);
        }

        .spiritual-root-option.selected {
            background: rgba(80, 60, 140, 0.9);
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(120, 80, 200, 0.7);
        }

        .root-name {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .root-desc {
            font-size: 12px;
            color: #a09070;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .item-slot {
            background: rgba(40, 30, 70, 0.7);
            border: 1px solid #5a4a8a;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .item-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
            background: rgba(100, 80, 160, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .item-name {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .item-count {
            font-size: 10px;
            color: #a09070;
        }

        .realm-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
            background: rgba(100, 80, 160, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }

        .realm-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .realm-item {
            display: flex;
            align-items: center;
            background: rgba(40, 30, 70, 0.7);
            border-radius: 8px;
            padding: 10px;
        }

        .realm-icon-small {
            width: 40px;
            height: 40px;
            background: rgba(100, 80, 160, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
        }

        .realm-info {
            flex: 1;
        }

        .realm-name {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .realm-desc {
            font-size: 12px;
            color: #a09070;
        }

        .realm-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(80, 60, 140, 0.7);
        }

        .realm-status.current {
            background: rgba(120, 80, 200, 0.7);
        }

        .realm-status.locked {
            background: rgba(60, 60, 80, 0.7);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(20, 15, 35, 0.9);
            border: 1px solid #8060c0;
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-title {
            font-size: 16px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .notification-desc {
            font-size: 14px;
            color: var(--text-color);
        }

        .sound-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            margin-left: 15px;
        }

        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(10, 5, 20, 0.9);
            padding: 10px;
            z-index: 10;
        }

        .mobile-controls-scroll {
            display: flex;
            overflow-x: auto;
            gap: 10px;
        }

        .mobile-btn {
            background: linear-gradient(to bottom, #3a2a5a, #5a4a8a);
            border: 1px solid #8060c0;
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 8px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .warning-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .warning-overlay.low-health {
            background: radial-gradient(circle at center, transparent 0%, rgba(255, 0, 0, 0.1) 100%);
            box-shadow: inset 0 0 50px rgba(255, 0, 0, 0.3);
            animation: pulse-warning 2s infinite;
        }

        .warning-overlay.low-life {
            background: radial-gradient(circle at center, transparent 0%, rgba(255, 100, 0, 0.1) 100%);
            box-shadow: inset 0 0 50px rgba(255, 100, 0, 0.3);
            animation: pulse-warning 1.5s infinite;
        }

        @keyframes pulse-warning {
            0% { opacity: 0.3; }
            50% { opacity: 0.7; }
            100% { opacity: 0.3; }
        }

        .save-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(20, 15, 35, 0.8);
            border: 1px solid var(--success-color);
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 12px;
            color: var(--success-color);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .save-indicator.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .game-content {
                flex-direction: column;
            }

            .action-panel {
                max-width: 100%;
                border-left: none;
                border-top: 2px solid;
                border-image: linear-gradient(to right, #8060c0, var(--primary-color)) 1;
                border-radius: 0;
            }

            .mobile-controls {
                display: block;
            }

            .choice-buttons {
                flex-direction: column;
            }

            .choice-btn {
                width: 100%;
            }

            .spiritual-root-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .item-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .popup {
                width: 95%;
                height: 95%;
                overflow-y: auto;
            }
        }

        @media (max-width: 375px) {
            .game-header {
                padding: 10px;
            }

            .player-info {
                gap: 10px;
            }

            .stat-value {
                font-size: 16px;
            }

            .narrative-panel {
                padding: 15px;
            }

            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }

            .action-panel {
                padding: 15px;
            }

            .action-btn {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="game-header">
            <div class="game-title">ä¿®çœŸä¸–ç•Œ Â· åŠ¨æ€å™äº‹å¼•æ“</div>
            <div class="player-info">
                <div class="player-stat">
                    <div class="stat-value" id="realm-display">å‡¡äºº</div>
                    <div class="stat-label">å¢ƒç•Œ</div>
                </div>
                <div class="player-stat">
                    <div class="stat-value" id="life-display">20/80</div>
                    <div class="stat-label">å¯¿å…ƒ</div>
                </div>
                <div class="player-stat">
                    <div class="stat-value" id="cultivation-display">0%</div>
                    <div class="stat-label">ä¿®ä¸º</div>
                </div>
                <button class="sound-toggle" id="sound-toggle">ğŸ”Š</button>
            </div>
        </div>

        <div class="game-content">
            <div class="scene-container">
                <canvas id="game-canvas"></canvas>
                <div class="ui-overlay"></div>
                <div class="warning-overlay" id="warning-overlay"></div>

                <div class="narrative-panel">
                    <div class="narrative-text" id="narrative-text">
                        ä½ ç¼“ç¼“çå¼€çœ¼ç›ï¼Œå‘ç°è‡ªå·±èº«å¤„ä¸€ç‰‡äº‘é›¾ç¼­ç»•çš„å±±è°·ä¹‹ä¸­ã€‚è¿œå¤„ä¼ æ¥ä»™é¹¤çš„é¸£å«ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€æµ“éƒçš„çµæ°”ã€‚ä½œä¸ºä¸€ååˆå…¥ä¿®çœŸç•Œçš„å‡¡äººï¼Œä½ æ„Ÿå—åˆ°ä½“å†…å¾®å¼±çš„çµåŠ›æ­£åœ¨ä¸å¤©åœ°å…±é¸£...
                    </div>
                    <div class="choice-buttons" id="choice-buttons">
                        <button class="choice-btn" data-choice="1">å°è¯•æ„Ÿåº”å¤©åœ°çµæ°”</button>
                        <button class="choice-btn" data-choice="2">æ¢ç´¢å‘¨å›´ç¯å¢ƒ</button>
                        <button class="choice-btn" data-choice="3">é™åè°ƒæ¯ï¼Œæ„Ÿå—ä½“å†…å˜åŒ–</button>
                    </div>
                </div>
            </div>

            <div class="action-panel">
                <div class="panel-title">ä¿®çœŸæ“ä½œ</div>
                <div class="action-buttons">
                    <button class="action-btn" id="cultivate-btn">æ‰“åä¿®ç‚¼ Â· æå‡ä¿®ä¸º</button>
                    <button class="action-btn" id="auto-cultivate-btn">è‡ªåŠ¨ä¿®ç‚¼ï¼ˆ10æ¬¡ï¼‰</button>
                    <button class="action-btn" id="explore-btn">æ¢ç´¢å¯»å® Â· è§¦å‘å¥‡é‡</button>
                    <button class="action-btn" id="breakthrough-btn">çªç ´å¢ƒç•Œ Â· é€†å¤©æ”¹å‘½</button>
                    <button class="action-btn" id="alchemy-btn">ç‚¼åˆ¶ä¸¹è¯ Â· è¾…åŠ©ä¿®è¡Œ</button>
                    <button class="action-btn" id="mission-btn">å®—é—¨ä»»åŠ¡ Â· ç§¯ç´¯èµ„æº</button>
                    <button class="action-btn" id="inventory-btn">èƒŒåŒ… Â· æŸ¥çœ‹ç‰©å“</button>
                    <button class="action-btn" id="worldview-btn">ä¿®çœŸä¸–ç•Œè§‚</button>
                    <button class="action-btn" id="achievement-btn">æˆå°± Â· æŸ¥çœ‹è¿›åº¦</button>
                    <button class="action-btn" id="settings-btn">è®¾ç½® Â· å­˜æ¡£ç®¡ç†</button>
                </div>

                <div class="panel-title">è§’è‰²çŠ¶æ€</div>
                <div class="status-panel">
                    <div class="status-item">
                        <span>
                            <span class="status-icon" style="color: var(--danger-color);">â¤</span>
                            æ°”è¡€:
                        </span>
                        <span id="health-value">100/100</span>
                    </div>
                    <div class="progress-bar health-bar">
                        <div class="progress-fill" id="health-bar" style="width: 100%"></div>
                        <div class="progress-glow"></div>
                    </div>

                    <div class="status-item">
                        <span>
                            <span class="status-icon" style="color: #6080ff;">ğŸ’§</span>
                            çµåŠ›:
                        </span>
                        <span id="mana-value">50/100</span>
                    </div>
                    <div class="progress-bar mana-bar">
                        <div class="progress-fill" id="mana-bar" style="width: 50%"></div>
                        <div class="progress-glow"></div>
                    </div>

                    <div class="status-item">
                        <span>
                            <span class="status-icon" style="color: #a0ffa0;">ğŸ¦´</span>
                            æ ¹éª¨:
                        </span>
                        <span id="talent-value">5</span>
                    </div>

                    <div class="status-item">
                        <span>
                            <span class="status-icon" style="color: #ffd700;">ğŸ€</span>
                            ç¦ç¼˜:
                        </span>
                        <span id="luck-value">3</span>
                    </div>

                    <div class="status-item">
                        <span>
                            <span class="status-icon" style="color: var(--primary-color);">â˜¯</span>
                            é“å¿ƒ:
                        </span>
                        <span id="dao-value">10</span>
                    </div>

                    <div class="status-item">
                        <span>çµæ ¹:</span>
                        <span id="spiritual-root-value">æœªé€‰æ‹©</span>
                    </div>

                    <div class="status-item">
                        <span>åŠŸæ³•:</span>
                        <span id="technique-value">åŸºç¡€åçº³</span>
                    </div>

                    <div class="status-item">
                        <span>å®—é—¨:</span>
                        <span id="sect-value">æ— </span>
                    </div>
                </div>

                <div class="panel-title">ä¿®ä¸ºè¿›åº¦</div>
                <div class="progress-bar cultivation-bar">
                    <div class="progress-fill" id="cultivation-bar" style="width: 0%"></div>
                    <div class="progress-glow"></div>
                </div>

                <div class="panel-title">å› æœè®°å½•</div>
                <div class="status-panel" id="karma-log">
                    <div>åˆå…¥ä¿®çœŸç•Œ</div>
                </div>
            </div>
        </div>

        <div class="mobile-controls">
            <div class="mobile-controls-scroll">
                <button class="mobile-btn" id="mobile-cultivate">ä¿®ç‚¼</button>
                <button class="mobile-btn" id="mobile-auto-cultivate">è‡ªåŠ¨ä¿®ç‚¼</button>
                <button class="mobile-btn" id="mobile-explore">æ¢ç´¢</button>
                <button class="mobile-btn" id="mobile-breakthrough">çªç ´</button>
                <button class="mobile-btn" id="mobile-alchemy">ç‚¼ä¸¹</button>
                <button class="mobile-btn" id="mobile-mission">ä»»åŠ¡</button>
                <button class="mobile-btn" id="mobile-inventory">èƒŒåŒ…</button>
                <button class="mobile-btn" id="mobile-settings">è®¾ç½®</button>
            </div>
        </div>

        <div class="loading-screen" id="loading-screen">
            <div class="loading-text" id="loading-text">å¤©é“æ¼”ç®—ä¸­...</div>
            <div class="loading-bar">
                <div class="loading-fill" id="loading-fill"></div>
            </div>
        </div>

        <div class="save-indicator" id="save-indicator">âœ“ å·²å­˜æ¡£</div>

        <!-- çµæ ¹é€‰æ‹©å¼¹çª— -->
        <div class="popup" id="spiritual-root-popup">
            <button class="close-popup" id="close-spiritual-root">Ã—</button>
            <div class="popup-title">é€‰æ‹©ä½ çš„çµæ ¹</div>
            <div class="popup-content">
                <div class="section-title">çµæ ¹å±æ€§</div>
                <p>çµæ ¹ä¹ƒä¿®çœŸä¹‹åŸºï¼Œå†³å®šä½ çš„ä¿®ç‚¼æ–¹å‘ä¸å¤©èµ‹ã€‚è¯·æ…é‡é€‰æ‹©ä½ çš„çµæ ¹å±æ€§ï¼š</p>

                <div class="spiritual-root-options">
                    <div class="spiritual-root-option" data-root="é‡‘">
                        <div class="root-name">é‡‘çµæ ¹</div>
                        <div class="root-desc">æ”»å‡»+5ï¼Œä¿®ç‚¼é€Ÿåº¦+10%</div>
                    </div>
                    <div class="spiritual-root-option" data-root="æœ¨">
                        <div class="root-name">æœ¨çµæ ¹</div>
                        <div class="root-desc">æ°”è¡€æ¢å¤+20%ï¼Œç‚¼ä¸¹æˆåŠŸç‡+15%</div>
                    </div>
                    <div class="spiritual-root-option" data-root="æ°´">
                        <div class="root-name">æ°´çµæ ¹</div>
                        <div class="root-desc">çµåŠ›æ¢å¤+20%ï¼Œé“å¿ƒ+3</div>
                    </div>
                    <div class="spiritual-root-option" data-root="ç«">
                        <div class="root-name">ç«çµæ ¹</div>
                        <div class="root-desc">æ”»å‡»+10ï¼Œä¿®ç‚¼é€Ÿåº¦+5%</div>
                    </div>
                    <div class="spiritual-root-option" data-root="åœŸ">
                        <div class="root-name">åœŸçµæ ¹</div>
                        <div class="root-desc">é˜²å¾¡+8ï¼Œæ°”è¡€+20</div>
                    </div>
                    <div class="spiritual-root-option" data-root="é›·">
                        <div class="root-name">é›·çµæ ¹</div>
                        <div class="root-desc">ä¿®ç‚¼é€Ÿåº¦+20%ï¼Œçªç ´éš¾åº¦+15%</div>
                    </div>
                    <div class="spiritual-root-option" data-root="é£">
                        <div class="root-name">é£çµæ ¹</div>
                        <div class="root-desc">ä¿®ç‚¼é€Ÿåº¦+15%ï¼Œç¦ç¼˜+2</div>
                    </div>
                    <div class="spiritual-root-option" data-root="å†°">
                        <div class="root-name">å†°çµæ ¹</div>
                        <div class="root-desc">é˜²å¾¡+5ï¼Œé“å¿ƒ+5</div>
                    </div>
                </div>

                <button class="choice-btn" id="confirm-spiritual-root" style="width: 100%; margin-top: 20px;">ç¡®è®¤é€‰æ‹©</button>
            </div>
        </div>

        <!-- ä¸–ç•Œè§‚å¼¹çª— -->
        <div class="popup" id="worldview-popup">
            <button class="close-popup" id="close-worldview">Ã—</button>
            <div class="popup-title">ä¿®çœŸä¸–ç•Œè§‚</div>
            <div class="popup-content">
                <div class="worldview-section">
                    <div class="section-title">å¢ƒç•Œä½“ç³»</div>
                    <p>ä¿®çœŸä¹‹è·¯æ¼«é•¿è€Œè‰°è¾›ï¼Œåˆ†ä¸ºå…«å¤§å¢ƒç•Œï¼šå‡¡äººã€ç‚¼æ°”ã€ç­‘åŸºã€é‡‘ä¸¹ã€å…ƒå©´ã€åŒ–ç¥ã€æ¸¡åŠ«ã€å¤§ä¹˜ã€‚æ¯ä¸ªå¢ƒç•Œåˆåˆ†å‰ã€ä¸­ã€åä¸‰æœŸã€‚</p>
                    <p>å‡¡äººå¯¿å…ƒä¸è¿‡ç™¾è½½ï¼Œè€Œç­‘åŸºä¿®å£«å¯è¾¾ä¸‰ç™¾å²ï¼Œé‡‘ä¸¹çœŸäººäº”ç™¾å¯¿ï¼Œå…ƒå©´çœŸå›åƒè½½å²æœˆï¼ŒåŒ–ç¥å°Šè€…ä¸¤åƒå¹´ï¼Œæ¸¡åŠ«å¤§èƒ½äº”åƒå¯¿å…ƒï¼Œå¤§ä¹˜ä»™å°Šä¸å¤©åœ°åŒå¯¿ã€‚</p>
                </div>

                <div class="worldview-section">
                    <div class="section-title">çµæ ¹å±æ€§</div>
                    <p>çµæ ¹ä¹ƒä¿®çœŸä¹‹åŸºï¼Œåˆ†äº”è¡Œï¼šé‡‘ã€æœ¨ã€æ°´ã€ç«ã€åœŸï¼Œä»¥åŠå˜å¼‚çµæ ¹ï¼šé›·ã€é£ã€å†°ã€‚çµæ ¹å“è´¨å†³å®šä¿®ç‚¼é€Ÿåº¦ä¸åŠŸæ³•å¥‘åˆåº¦ã€‚</p>
                    <p>å•ä¸€çµæ ¹ä¿®ç‚¼æœ€å¿«ä½†ç¥é€šå•ä¸€ï¼Œå¤šçµæ ¹ç¥é€šå¹¿å¤§ä½†ä¿®ç‚¼ç¼“æ…¢ã€‚å¤©çµæ ¹ä¹ƒå¤©ä¹‹éª„å­ï¼Œä¿®ç‚¼é€Ÿåº¦è¿œè¶…å¸¸äººã€‚</p>
                </div>

                <div class="worldview-section">
                    <div class="section-title">ä¿®ç‚¼è·¯å¾„</div>
                    <p>ä¿®çœŸè€…å¯é€‰æ‹©ä¸åŒä¿®ç‚¼è·¯å¾„ï¼šç‚¼ä¸¹ä¹‹é“ã€ç‚¼å™¨ä¹‹é“ã€ç¬¦ç®“ä¹‹é“ã€é˜µæ³•ä¹‹é“ã€æˆ˜æ–—ä¹‹é“ç­‰ã€‚æ¯ç§è·¯å¾„éƒ½æœ‰ç‹¬ç‰¹çš„ä¼˜åŠ¿ä¸ç“¶é¢ˆã€‚</p>
                    <p>å¤§é“ä¸‰åƒï¼Œæ®Šé€”åŒå½’ã€‚æ— è®ºé€‰æ‹©ä½•ç§è·¯å¾„ï¼Œæœ€ç»ˆç›®æ ‡éƒ½æ˜¯å‚æ‚Ÿå¤©åœ°æ³•åˆ™ï¼Œæˆå°±æ— ä¸Šå¤§é“ã€‚</p>
                </div>

                <div class="worldview-section">
                    <div class="section-title">å› æœå¾ªç¯</div>
                    <p>ä¿®çœŸç•Œè®²ç©¶å› æœå¾ªç¯ï¼Œå–„å› å¾—å–„æœï¼Œæ¶å› å¾—æ¶æŠ¥ã€‚ä¿®å£«çš„è¡Œä¸ºä¼šå½±å“é“å¿ƒä¸ç¦ç¼˜ï¼Œè¿›è€Œå½±å“ä¿®ç‚¼é€Ÿåº¦ä¸çªç ´æˆåŠŸç‡ã€‚</p>
                    <p>å¤§é“è‡³å…¬ï¼Œå¤©é“é…¬å‹¤ã€‚å”¯æœ‰åšå®ˆæœ¬å¿ƒï¼Œæ–¹èƒ½åœ¨è¿™æ¡é€†å¤©è€Œè¡Œçš„é“è·¯ä¸Šèµ°å¾—æ›´è¿œã€‚</p>
                </div>
            </div>
        </div>

        <!-- èƒŒåŒ…å¼¹çª— -->
        <div class="popup" id="inventory-popup">
            <button class="close-popup" id="close-inventory">Ã—</button>
            <div class="popup-title">èƒŒåŒ…</div>
            <div class="popup-content">
                <div class="section-title">ä¸¹è¯</div>
                <div class="item-grid" id="potion-grid">
                    <!-- ä¸¹è¯ç‰©å“å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="section-title">ææ–™</div>
                <div class="item-grid" id="material-grid">
                    <!-- ææ–™ç‰©å“å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="section-title">åŠŸæ³•</div>
                <div class="item-grid" id="technique-grid">
                    <!-- åŠŸæ³•ç‰©å“å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- æˆå°±å¼¹çª— -->
        <div class="popup" id="achievement-popup">
            <button class="close-popup" id="close-achievement">Ã—</button>
            <div class="popup-title">æˆå°±ç³»ç»Ÿ</div>
            <div class="popup-content">
                <div class="section-title">å·²è¾¾æˆæˆå°±</div>
                <div class="realm-list" id="achieved-list">
                    <!-- å·²è¾¾æˆæˆå°±å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="section-title">æœªè¾¾æˆæˆå°±</div>
                <div class="realm-list" id="unachieved-list">
                    <!-- æœªè¾¾æˆæˆå°±å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- è®¾ç½®å¼¹çª— -->
        <div class="popup" id="settings-popup">
            <button class="close-popup" id="close-settings">Ã—</button>
            <div class="popup-title">æ¸¸æˆè®¾ç½®</div>
            <div class="popup-content">
                <div class="section-title">å­˜æ¡£ç®¡ç†</div>
                <div class="realm-list" id="save-slots">
                    <!-- å­˜æ¡£æ§½ä½å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="section-title">æ€§èƒ½è®¾ç½®</div>
                <div class="status-panel">
                    <div class="status-item">
                        <span>æ€§èƒ½æ¨¡å¼:</span>
                        <label class="switch">
                            <input type="checkbox" id="performance-mode">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="status-item">
                        <span>éŸ³æ•ˆ:</span>
                        <label class="switch">
                            <input type="checkbox" id="sound-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="section-title">æ•°æ®ç®¡ç†</div>
                <div class="choice-buttons">
                    <button class="choice-btn" id="export-save">å¯¼å‡ºå­˜æ¡£</button>
                    <button class="choice-btn" id="import-save">å¯¼å…¥å­˜æ¡£</button>
                    <button class="choice-btn" id="reset-game">é‡ç½®æ¸¸æˆ</button>
                </div>
            </div>
        </div>

        <!-- é€šçŸ¥å¼¹çª— -->
        <div class="notification" id="notification">
            <div class="notification-title" id="notification-title">æˆå°±è§£é”</div>
            <div class="notification-desc" id="notification-desc">é¦–æ¬¡çªç ´å¢ƒç•Œ</div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€ç®¡ç†
        const gameState = {
            player: {
                name: "æ— åä¿®å£«",
                realm: "å‡¡äºº",
                stage: 0,
                cultivation: 0,
                breakthrough: 100,
                health: 100,
                maxHealth: 100,
                mana: 50,
                maxMana: 100,
                talent: 5,
                luck: 3,
                dao: 10,
                life: 20,
                maxLife: 80,
                karma: ["åˆå…¥ä¿®çœŸç•Œ"],
                spiritualRoot: "",
                technique: "åŸºç¡€åçº³",
                sect: "æ— ",
                achievements: [],
                cultivationCount: 0,
                explorationCount: 0
            },
            inventory: {
                potions: {
                    "æ­¢è¡€è‰": { count: 5, type: "heal", value: 30 },
                    "ç‚¼æ°”æ•£": { count: 2, type: "mana", value: 50 },
                    "ç­‘åŸºä¸¹": { count: 0, type: "breakthrough", value: 1 }
                },
                materials: {
                    "çµæ°”æ¶²": { count: 0, type: "material" },
                    "å¦–å…½å†…ä¸¹": { count: 0, type: "material" },
                    "åƒå¹´äººå‚": { count: 0, type: "material" }
                },
                techniques: {
                    "åŸºç¡€åçº³": { level: 1, equipped: true, type: "cultivation" },
                    "çƒˆç„°è¯€": { level: 0, equipped: false, type: "fire" },
                    "å¯’å†°è¯€": { level: 0, equipped: false, type: "ice" }
                }
            },
            narrative: {
                current: "ä½ ç¼“ç¼“çå¼€çœ¼ç›ï¼Œå‘ç°è‡ªå·±èº«å¤„ä¸€ç‰‡äº‘é›¾ç¼­ç»•çš„å±±è°·ä¹‹ä¸­ã€‚è¿œå¤„ä¼ æ¥ä»™é¹¤çš„é¸£å«ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€æµ“éƒçš„çµæ°”ã€‚ä½œä¸ºä¸€ååˆå…¥ä¿®çœŸç•Œçš„å‡¡äººï¼Œä½ æ„Ÿå—åˆ°ä½“å†…å¾®å¼±çš„çµåŠ›æ­£åœ¨ä¸å¤©åœ°å…±é¸£...",
                choices: [
                    "å°è¯•æ„Ÿåº”å¤©åœ°çµæ°”",
                    "æ¢ç´¢å‘¨å›´ç¯å¢ƒ",
                    "é™åè°ƒæ¯ï¼Œæ„Ÿå—ä½“å†…å˜åŒ–"
                ]
            },
            loading: false,
            soundEnabled: true,
            eventCount: 0,
            performanceMode: false,
            saving: false
        };

        // å¢ƒç•Œä½“ç³»
        const realmSystem = {
            "å‡¡äºº": {
                maxLife: 80,
                maxHealth: 100,
                maxMana: 100,
                breakthroughExp: 100,
                next: "ç‚¼æ°”",
                daoRequired: 0
            },
            "ç‚¼æ°”": {
                maxLife: 100,
                maxHealth: 120,
                maxMana: 150,
                breakthroughExp: 200,
                next: "ç­‘åŸº",
                daoRequired: 20
            },
            "ç­‘åŸº": {
                maxLife: 300,
                maxHealth: 150,
                maxMana: 200,
                breakthroughExp: 500,
                next: "é‡‘ä¸¹",
                daoRequired: 50
            },
            "é‡‘ä¸¹": {
                maxLife: 500,
                maxHealth: 200,
                maxMana: 300,
                breakthroughExp: 1000,
                next: "å…ƒå©´",
                daoRequired: 80
            },
            "å…ƒå©´": {
                maxLife: 1000,
                maxHealth: 300,
                maxMana: 500,
                breakthroughExp: 2000,
                next: "åŒ–ç¥",
                daoRequired: 120
            },
            "åŒ–ç¥": {
                maxLife: 2000,
                maxHealth: 500,
                maxMana: 800,
                breakthroughExp: 5000,
                next: "æ¸¡åŠ«",
                daoRequired: 180
            },
            "æ¸¡åŠ«": {
                maxLife: 5000,
                maxHealth: 800,
                maxMana: 1200,
                breakthroughExp: 10000,
                next: "å¤§ä¹˜",
                daoRequired: 250
            },
            "å¤§ä¹˜": {
                maxLife: 10000,
                maxHealth: 1200,
                maxMana: 2000,
                breakthroughExp: 0,
                next: null,
                daoRequired: 0
            }
        };

        // çµæ ¹å±æ€§åŠ æˆ
        const rootEffects = {
            "é‡‘": { attack: 5, cultivationSpeed: 0.1 },
            "æœ¨": { healthRegen: 0.2, alchemySuccess: 0.15 },
            "æ°´": { manaRegen: 0.2, dao: 3 },
            "ç«": { attack: 10, cultivationSpeed: 0.05 },
            "åœŸ": { defense: 8, health: 20 },
            "é›·": { cultivationSpeed: 0.2, breakthroughDifficulty: 0.15 },
            "é£": { cultivationSpeed: 0.15, luck: 2 },
            "å†°": { defense: 5, dao: 5 }
        };

        // æˆå°±ç³»ç»Ÿ
        let achievements = {
            "first_breakthrough": {
                name: "é¦–æ¬¡çªç ´",
                description: "æˆåŠŸçªç ´åˆ°ç‚¼æ°”æœŸ",
                reward: { cultivation: 100 },
                achieved: false
            },
            "first_alchemy": {
                name: "ç‚¼ä¸¹æ–°æ‰‹",
                description: "æˆåŠŸç‚¼åˆ¶ç¬¬ä¸€é¢—ä¸¹è¯",
                reward: { talent: 1 },
                achieved: false
            },
            "cultivation_master": {
                name: "ä¿®ç‚¼è¾¾äºº",
                description: "ç´¯è®¡ä¿®ç‚¼10æ¬¡",
                reward: { cultivationSpeed: 0.1 },
                achieved: false
            },
            "exploration_expert": {
                name: "æ¢ç´¢ä¸“å®¶",
                description: "æ¢ç´¢10æ¬¡ä¸åŒåœ°ç‚¹",
                reward: { luck: 2 },
                achieved: false
            }
        };

        // éŸ³æ•ˆç³»ç»Ÿ - ä¿®å¤éŸ³æ•ˆURLé—®é¢˜
        const soundEffects = {
            cultivate: new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=='),
            breakthrough: new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=='),
            alchemy: new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=='),
            click: new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==')
        };

        // é¢„åŠ è½½éŸ³æ•ˆ
        Object.values(soundEffects).forEach(sound => {
            sound.load();
            sound.volume = 0.3;
        });

        // DOM å…ƒç´ å¼•ç”¨
        const elements = {
            realmDisplay: document.getElementById('realm-display'),
            lifeDisplay: document.getElementById('life-display'),
            cultivationDisplay: document.getElementById('cultivation-display'),
            narrativeText: document.getElementById('narrative-text'),
            choiceButtons: document.getElementById('choice-buttons'),
            healthValue: document.getElementById('health-value'),
            manaValue: document.getElementById('mana-value'),
            talentValue: document.getElementById('talent-value'),
            luckValue: document.getElementById('luck-value'),
            daoValue: document.getElementById('dao-value'),
            spiritualRootValue: document.getElementById('spiritual-root-value'),
            techniqueValue: document.getElementById('technique-value'),
            sectValue: document.getElementById('sect-value'),
            healthBar: document.getElementById('health-bar'),
            manaBar: document.getElementById('mana-bar'),
            cultivationBar: document.getElementById('cultivation-bar'),
            loadingScreen: document.getElementById('loading-screen'),
            loadingText: document.getElementById('loading-text'),
            loadingFill: document.getElementById('loading-fill'),
            spiritualRootPopup: document.getElementById('spiritual-root-popup'),
            closeSpiritualRoot: document.getElementById('close-spiritual-root'),
            confirmSpiritualRoot: document.getElementById('confirm-spiritual-root'),
            worldviewPopup: document.getElementById('worldview-popup'),
            closeWorldview: document.getElementById('close-worldview'),
            inventoryPopup: document.getElementById('inventory-popup'),
            closeInventory: document.getElementById('close-inventory'),
            achievementPopup: document.getElementById('achievement-popup'),
            closeAchievement: document.getElementById('close-achievement'),
            settingsPopup: document.getElementById('settings-popup'),
            closeSettings: document.getElementById('close-settings'),
            worldviewBtn: document.getElementById('worldview-btn'),
            cultivateBtn: document.getElementById('cultivate-btn'),
            autoCultivateBtn: document.getElementById('auto-cultivate-btn'),
            exploreBtn: document.getElementById('explore-btn'),
            breakthroughBtn: document.getElementById('breakthrough-btn'),
            alchemyBtn: document.getElementById('alchemy-btn'),
            missionBtn: document.getElementById('mission-btn'),
            inventoryBtn: document.getElementById('inventory-btn'),
            achievementBtn: document.getElementById('achievement-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            soundToggle: document.getElementById('sound-toggle'),
            karmaLog: document.getElementById('karma-log'),
            potionGrid: document.getElementById('potion-grid'),
            materialGrid: document.getElementById('material-grid'),
            techniqueGrid: document.getElementById('technique-grid'),
            achievedList: document.getElementById('achieved-list'),
            unachievedList: document.getElementById('unachieved-list'),
            notification: document.getElementById('notification'),
            notificationTitle: document.getElementById('notification-title'),
            notificationDesc: document.getElementById('notification-desc'),
            warningOverlay: document.getElementById('warning-overlay'),
            saveIndicator: document.getElementById('save-indicator'),
            saveSlots: document.getElementById('save-slots'),
            performanceMode: document.getElementById('performance-mode'),
            soundEnabled: document.getElementById('sound-enabled'),
            exportSave: document.getElementById('export-save'),
            importSave: document.getElementById('import-save'),
            resetGame: document.getElementById('reset-game')
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            console.log("åˆå§‹åŒ–æ¸¸æˆ...");

            // æ£€æŸ¥æ˜¯å¦æœ‰å­˜æ¡£
            const saveData = getSaveData();
            if (saveData && saveData[1]) {
                if (confirm('æ£€æµ‹åˆ°å­˜æ¡£ï¼Œæ˜¯å¦ç»§ç»­ä¸Šæ¬¡æ¸¸æˆï¼Ÿ')) {
                    loadGameFromSlot(1);
                } else {
                    showSpiritualRootSelection();
                }
            } else {
                showSpiritualRootSelection();
            }

            setupEventListeners();
            initCanvas();

            // æ¨¡æ‹Ÿåˆå§‹åŠ è½½å®Œæˆ
            setTimeout(() => {
                elements.loadingFill.style.width = '100%';
                setTimeout(() => {
                    elements.loadingScreen.style.display = 'none';
                    createParticles();
                    updateUI();
                }, 500);
            }, 1500);
        }

        // æ˜¾ç¤ºçµæ ¹é€‰æ‹©ç•Œé¢
        function showSpiritualRootSelection() {
            elements.spiritualRootPopup.classList.add('active');

            // æ·»åŠ çµæ ¹é€‰æ‹©äº‹ä»¶
            const rootOptions = document.querySelectorAll('.spiritual-root-option');
            rootOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
                    rootOptions.forEach(opt => opt.classList.remove('selected'));
                    // è®¾ç½®å½“å‰é€‰æ‹©
                    this.classList.add('selected');
                });
            });

            // ç¡®è®¤é€‰æ‹©
            elements.confirmSpiritualRoot.addEventListener('click', function() {
                const selected = document.querySelector('.spiritual-root-option.selected');
                if (selected) {
                    const root = selected.dataset.root;
                    gameState.player.spiritualRoot = root;

                    // åº”ç”¨çµæ ¹æ•ˆæœ
                    applyRootEffects(root);

                    // æ›´æ–°UI
                    updateUI();

                    // å…³é—­å¼¹çª—
                    closePopup(elements.spiritualRootPopup);

                    // æ˜¾ç¤ºé€šçŸ¥
                    showNotification("çµæ ¹è§‰é†’", `ä½ è§‰é†’äº†${root}çµæ ¹ï¼Œè·å¾—äº†ç›¸åº”çš„å¤©èµ‹åŠ æˆï¼`);
                } else {
                    alert('è¯·é€‰æ‹©ä¸€ç§çµæ ¹ï¼');
                }
            });
        }

        // åº”ç”¨çµæ ¹æ•ˆæœ
        function applyRootEffects(root) {
            const effects = rootEffects[root];

            if (effects.attack) {
                // æ”»å‡»åŠ›åŠ æˆå°†åœ¨æˆ˜æ–—ç³»ç»Ÿä¸­ä½¿ç”¨
            }

            if (effects.health) {
                gameState.player.maxHealth += effects.health;
                gameState.player.health = gameState.player.maxHealth;
            }

            if (effects.dao) {
                gameState.player.dao += effects.dao;
            }

            if (effects.luck) {
                gameState.player.luck += effects.luck;
            }
        }

        // æ›´æ–°UIæ˜¾ç¤º
        function updateUI() {
            elements.realmDisplay.textContent = gameState.player.realm;
            elements.lifeDisplay.textContent = `${gameState.player.life}/${gameState.player.maxLife}`;

            const cultivationPercent = Math.round(gameState.player.cultivation / gameState.player.breakthrough * 100);
            elements.cultivationDisplay.textContent = `${cultivationPercent}%`;
            elements.cultivationBar.style.width = `${cultivationPercent}%`;

            elements.narrativeText.textContent = gameState.narrative.current;

            elements.healthValue.textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            elements.manaValue.textContent = `${gameState.player.mana}/${gameState.player.maxMana}`;
            elements.talentValue.textContent = gameState.player.talent;
            elements.luckValue.textContent = gameState.player.luck;
            elements.daoValue.textContent = gameState.player.dao;
            elements.spiritualRootValue.textContent = gameState.player.spiritualRoot || "æœªé€‰æ‹©";
            elements.techniqueValue.textContent = gameState.player.technique;
            elements.sectValue.textContent = gameState.player.sect;

            elements.healthBar.style.width = `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
            elements.manaBar.style.width = `${(gameState.player.mana / gameState.player.maxMana) * 100}%`;

            // æ›´æ–°å› æœè®°å½•
            elements.karmaLog.innerHTML = '';
            gameState.player.karma.forEach(karma => {
                const div = document.createElement('div');
                div.textContent = karma;
                elements.karmaLog.appendChild(div);
            });

            // æ›´æ–°é€‰æ‹©æŒ‰é’®
            elements.choiceButtons.innerHTML = '';
            gameState.narrative.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = choice;
                button.dataset.choice = index + 1;
                elements.choiceButtons.appendChild(button);
            });

            // æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
            updateInventoryDisplay();

            // æ›´æ–°æˆå°±æ˜¾ç¤º
            updateAchievementsDisplay();

            // æ›´æ–°å­˜æ¡£æ§½ä½æ˜¾ç¤º
            updateSaveSlotsDisplay();

            // æ£€æŸ¥è­¦å‘ŠçŠ¶æ€
            checkWarnings();
        }

        // æ£€æŸ¥è­¦å‘ŠçŠ¶æ€
        function checkWarnings() {
            const healthPercent = gameState.player.health / gameState.player.maxHealth;
            const lifePercent = gameState.player.life / gameState.player.maxLife;

            elements.warningOverlay.className = 'warning-overlay';

            if (healthPercent < 0.3) {
                elements.warningOverlay.classList.add('low-health');
                if (healthPercent < 0.1) {
                    showNotification("ç”Ÿå‘½å±æ€¥", "æ°”è¡€è¿‡ä½ï¼Œå»ºè®®ç«‹å³æ¢å¤ï¼");
                }
            }

            if (lifePercent < 0.1) {
                elements.warningOverlay.classList.add('low-life');
                showNotification("å¯¿å…ƒå°†å°½", "å¯¿å…ƒå³å°†è€—å°½ï¼Œå»ºè®®å¯»æ‰¾å»¶å¯¿ä¸¹è¯ï¼");
            }
        }

        // æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
        function updateInventoryDisplay() {
            // æ¸…ç©ºç°æœ‰å†…å®¹
            elements.potionGrid.innerHTML = '';
            elements.materialGrid.innerHTML = '';
            elements.techniqueGrid.innerHTML = '';

            // æ·»åŠ ä¸¹è¯
            for (const [name, data] of Object.entries(gameState.inventory.potions)) {
                if (data.count > 0) {
                    const item = createInventoryItem(name, data.count, 'potion');
                    elements.potionGrid.appendChild(item);
                }
            }

            // æ·»åŠ ææ–™
            for (const [name, data] of Object.entries(gameState.inventory.materials)) {
                if (data.count > 0) {
                    const item = createInventoryItem(name, data.count, 'material');
                    elements.materialGrid.appendChild(item);
                }
            }

            // æ·»åŠ å·¥æ³•
            for (const [name, data] of Object.entries(gameState.inventory.techniques)) {
                const item = createInventoryItem(name, data.level, 'technique', data.equipped);
                elements.techniqueGrid.appendChild(item);
            }
        }

        // åˆ›å»ºèƒŒåŒ…ç‰©å“
        function createInventoryItem(name, count, type, equipped = false) {
            const item = document.createElement('div');
            item.className = 'item-slot';
            if (equipped) item.style.borderColor = 'var(--primary-color)';

            const icon = document.createElement('div');
            icon.className = 'item-icon';

            const nameEl = document.createElement('div');
            nameEl.className = 'item-name';
            nameEl.textContent = name;

            const countEl = document.createElement('div');
            countEl.className = 'item-count';
            countEl.textContent = type === 'technique' ? `Lv.${count}` : `x${count}`;

            item.appendChild(icon);
            item.appendChild(nameEl);
            item.appendChild(countEl);

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            item.addEventListener('click', () => {
                if (type === 'potion') {
                    usePotion(name);
                } else if (type === 'technique') {
                    equipTechnique(name);
                }
            });

            return item;
        }

        // ä½¿ç”¨ä¸¹è¯
        function usePotion(name) {
            const potion = gameState.inventory.potions[name];
            if (potion && potion.count > 0) {
                potion.count--;

                if (potion.type === 'heal') {
                    gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + potion.value);
                    showFloatingText(elements.healthValue, `+${potion.value}`, 'health');
                } else if (potion.type === 'mana') {
                    gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + potion.value);
                    showFloatingText(elements.manaValue, `+${potion.value}`, 'mana');
                }

                updateUI();
                showNotification("ä½¿ç”¨ä¸¹è¯", `ä½¿ç”¨äº†${name}ï¼Œæ¢å¤äº†${potion.value}ç‚¹${potion.type === 'heal' ? 'æ°”è¡€' : 'çµåŠ›'}`);

                // å­˜æ¡£
                saveGame();
            }
        }

        // è£…å¤‡åŠŸæ³•
        function equipTechnique(name) {
            // å…ˆå–æ¶ˆæ‰€æœ‰åŠŸæ³•çš„è£…å¤‡çŠ¶æ€
            for (const techName in gameState.inventory.techniques) {
                gameState.inventory.techniques[techName].equipped = false;
            }

            // è£…å¤‡é€‰æ‹©çš„åŠŸæ³•
            gameState.inventory.techniques[name].equipped = true;
            gameState.player.technique = name;

            updateUI();
            showNotification("åŠŸæ³•åˆ‡æ¢", `å·²è£…å¤‡åŠŸæ³•ï¼š${name}`);

            // å­˜æ¡£
            saveGame();
        }

        // æ›´æ–°æˆå°±æ˜¾ç¤º
        function updateAchievementsDisplay() {
            elements.achievedList.innerHTML = '';
            elements.unachievedList.innerHTML = '';

            for (const [id, achievement] of Object.entries(achievements)) {
                const item = document.createElement('div');
                item.className = 'realm-item';

                const icon = document.createElement('div');
                icon.className = 'realm-icon-small';
                icon.textContent = achievement.achieved ? 'âœ“' : '?';

                const info = document.createElement('div');
                info.className = 'realm-info';

                const name = document.createElement('div');
                name.className = 'realm-name';
                name.textContent = achievement.name;

                const desc = document.createElement('div');
                desc.className = 'realm-desc';
                desc.textContent = achievement.description;

                info.appendChild(name);
                info.appendChild(desc);

                const status = document.createElement('div');
                status.className = `realm-status ${achievement.achieved ? 'current' : 'locked'}`;
                status.textContent = achievement.achieved ? 'å·²è¾¾æˆ' : 'æœªè¾¾æˆ';

                item.appendChild(icon);
                item.appendChild(info);
                item.appendChild(status);

                if (achievement.achieved) {
                    elements.achievedList.appendChild(item);
                } else {
                    elements.unachievedList.appendChild(item);
                }
            }
        }

        // æ›´æ–°å­˜æ¡£æ§½ä½æ˜¾ç¤º
        function updateSaveSlotsDisplay() {
            elements.saveSlots.innerHTML = '';

            // è·å–å­˜æ¡£æ•°æ®
            const saveData = getSaveData();

            // åˆ›å»ºå­˜æ¡£æ§½ä½
            for (let i = 1; i <= 3; i++) {
                const slot = document.createElement('div');
                slot.className = 'realm-item';

                const icon = document.createElement('div');
                icon.className = 'realm-icon-small';
                icon.textContent = i;

                const info = document.createElement('div');
                info.className = 'realm-info';

                const name = document.createElement('div');
                name.className = 'realm-name';
                name.textContent = `å­˜æ¡£ ${i}`;

                const desc = document.createElement('div');
                desc.className = 'realm-desc';

                if (saveData[i]) {
                    desc.textContent = `${saveData[i].player.realm} - ${saveData[i].player.name} - ${new Date(saveData[i].lastSaveTime).toLocaleDateString()}`;
                } else {
                    desc.textContent = 'ç©ºå­˜æ¡£';
                }

                info.appendChild(name);
                info.appendChild(desc);

                const status = document.createElement('div');
                status.className = 'realm-status';
                status.textContent = saveData[i] ? 'åŠ è½½' : 'æ–°å»º';

                slot.appendChild(icon);
                slot.appendChild(info);
                slot.appendChild(status);

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                slot.addEventListener('click', () => {
                    if (saveData[i]) {
                        if (confirm(`ç¡®å®šè¦åŠ è½½å­˜æ¡£ ${i} å—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚`)) {
                            loadGameFromSlot(i);
                        }
                    } else {
                        if (confirm(`ç¡®å®šè¦åœ¨å­˜æ¡£ ${i} åˆ›å»ºæ–°æ¸¸æˆå—ï¼Ÿ`)) {
                            createNewGameInSlot(i);
                        }
                    }
                });

                elements.saveSlots.appendChild(slot);
            }
        }

        // è·å–å­˜æ¡£æ•°æ®
        function getSaveData() {
            const saveData = localStorage.getItem('immortalSaveSlots');
            return saveData ? JSON.parse(saveData) : {};
        }

        // ä¿å­˜å­˜æ¡£æ•°æ®
        function saveGameData(saveData) {
            localStorage.setItem('immortalSaveSlots', JSON.stringify(saveData));
        }

        // ä»æ§½ä½åŠ è½½æ¸¸æˆ
        function loadGameFromSlot(slotId) {
            const saveData = getSaveData();
            if (saveData[slotId]) {
                // åŠ è½½æ¸¸æˆæ•°æ®
                gameState.player = saveData[slotId].player;
                gameState.inventory = saveData[slotId].inventory;
                gameState.narrative = saveData[slotId].narrative;
                gameState.eventCount = saveData[slotId].eventCount || 0;

                // åŠ è½½æˆå°±çŠ¶æ€
                if (saveData[slotId].achievements) {
                    for (const [id, achievement] of Object.entries(saveData[slotId].achievements)) {
                        if (achievements[id]) {
                            achievements[id].achieved = achievement.achieved;
                        }
                    }
                }

                updateUI();
                showNotification("åŠ è½½æˆåŠŸ", `å·²åŠ è½½å­˜æ¡£ ${slotId}`);
            }
        }

        // åœ¨æ§½ä½åˆ›å»ºæ–°æ¸¸æˆ
        function createNewGameInSlot(slotId) {
            // åˆ›å»ºæ–°çš„æ¸¸æˆçŠ¶æ€
            const newGameState = {
                player: {
                    name: "æ— åä¿®å£«",
                    realm: "å‡¡äºº",
                    stage: 0,
                    cultivation: 0,
                    breakthrough: 100,
                    health: 100,
                    maxHealth: 100,
                    mana: 50,
                    maxMana: 100,
                    talent: 5,
                    luck: 3,
                    dao: 10,
                    life: 20,
                    maxLife: 80,
                    karma: ["åˆå…¥ä¿®çœŸç•Œ"],
                    spiritualRoot: "",
                    technique: "åŸºç¡€åçº³",
                    sect: "æ— ",
                    achievements: [],
                    cultivationCount: 0,
                    explorationCount: 0
                },
                inventory: {
                    potions: {
                        "æ­¢è¡€è‰": { count: 5, type: "heal", value: 30 },
                        "ç‚¼æ°”æ•£": { count: 2, type: "mana", value: 50 },
                        "ç­‘åŸºä¸¹": { count: 0, type: "breakthrough", value: 1 }
                    },
                    materials: {
                        "çµæ°”æ¶²": { count: 0, type: "material" },
                        "å¦–å…½å†…ä¸¹": { count: 0, type: "material" },
                        "åƒå¹´äººå‚": { count: 0, type: "material" }
                    },
                    techniques: {
                        "åŸºç¡€åçº³": { level: 1, equipped: true, type: "cultivation" },
                        "çƒˆç„°è¯€": { level: 0, equipped: false, type: "fire" },
                        "å¯’å†°è¯€": { level: 0, equipped: false, type: "ice" }
                    }
                },
                narrative: {
                    current: "ä½ ç¼“ç¼“çå¼€çœ¼ç›ï¼Œå‘ç°è‡ªå·±èº«å¤„ä¸€ç‰‡äº‘é›¾ç¼­ç»•çš„å±±è°·ä¹‹ä¸­ã€‚è¿œå¤„ä¼ æ¥ä»™é¹¤çš„é¸£å«ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€æµ“éƒçš„çµæ°”ã€‚ä½œä¸ºä¸€ååˆå…¥ä¿®çœŸç•Œçš„å‡¡äººï¼Œä½ æ„Ÿå—åˆ°ä½“å†…å¾®å¼±çš„çµåŠ›æ­£åœ¨ä¸å¤©åœ°å…±é¸£...",
                    choices: [
                        "å°è¯•æ„Ÿåº”å¤©åœ°çµæ°”",
                        "æ¢ç´¢å‘¨å›´ç¯å¢ƒ",
                        "é™åè°ƒæ¯ï¼Œæ„Ÿå—ä½“å†…å˜åŒ–"
                    ]
                },
                eventCount: 0,
                lastSaveTime: Date.now()
            };

            // ä¿å­˜åˆ°æ§½ä½
            const saveData = getSaveData();
            saveData[slotId] = newGameState;
            saveGameData(saveData);

            // åŠ è½½æ–°æ¸¸æˆ
            loadGameFromSlot(slotId);
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // é€‰æ‹©æŒ‰é’®äº‹ä»¶å§”æ‰˜
            elements.choiceButtons.addEventListener('click', (e) => {
                if (e.target.classList.contains('choice-btn')) {
                    playSound('click');
                    handleChoice(parseInt(e.target.dataset.choice));
                }
            });

            // æ“ä½œæŒ‰é’®äº‹ä»¶
            elements.cultivateBtn.addEventListener('click', (e) => {
                playSound('cultivate');
                handleAction('cultivate', e.target);
            });
            elements.autoCultivateBtn.addEventListener('click', (e) => {
                playSound('cultivate');
                handleAutoCultivate(e.target);
            });
            elements.exploreBtn.addEventListener('click', (e) => {
                playSound('click');
                handleAction('explore', e.target);
            });
            elements.breakthroughBtn.addEventListener('click', (e) => {
                playSound('breakthrough');
                handleAction('breakthrough', e.target);
            });
            elements.alchemyBtn.addEventListener('click', (e) => {
                playSound('alchemy');
                handleAction('alchemy', e.target);
            });
            elements.missionBtn.addEventListener('click', (e) => {
                playSound('click');
                handleAction('mission', e.target);
            });
            elements.inventoryBtn.addEventListener('click', () => {
                playSound('click');
                showPopup(elements.inventoryPopup);
            });
            elements.achievementBtn.addEventListener('click', () => {
                playSound('click');
                showPopup(elements.achievementPopup);
            });
            elements.worldviewBtn.addEventListener('click', () => {
                playSound('click');
                showPopup(elements.worldviewPopup);
            });
            elements.settingsBtn.addEventListener('click', () => {
                playSound('click');
                showPopup(elements.settingsPopup);
            });

            // ç§»åŠ¨ç«¯æŒ‰é’®äº‹ä»¶
            document.getElementById('mobile-cultivate').addEventListener('click', (e) => {
                playSound('cultivate');
                handleAction('cultivate', e.target);
            });
            document.getElementById('mobile-auto-cultivate').addEventListener('click', (e) => {
                playSound('cultivate');
                handleAutoCultivate(e.target);
            });
            document.getElementById('mobile-explore').addEventListener('click', (e) => {
                playSound('click');
                handleAction('explore', e.target);
            });
            document.getElementById('mobile-breakthrough').addEventListener('click', (e) => {
                playSound('breakthrough');
                handleAction('breakthrough', e.target);
            });
            document.getElementById('mobile-alchemy').addEventListener('click', (e) => {
                playSound('alchemy');
                handleAction('alchemy', e.target);
            });
            document.getElementById('mobile-mission').addEventListener('click', (e) => {
                playSound('click');
                handleAction('mission', e.target);
            });
            document.getElementById('mobile-inventory').addEventListener('click', () => {
                playSound('click');
                showPopup(elements.inventoryPopup);
            });
            document.getElementById('mobile-settings').addEventListener('click', () => {
                playSound('click');
                showPopup(elements.settingsPopup);
            });

            // å…³é—­å¼¹çª—äº‹ä»¶
            elements.closeSpiritualRoot.addEventListener('click', () => closePopup(elements.spiritualRootPopup));
            elements.closeWorldview.addEventListener('click', () => closePopup(elements.worldviewPopup));
            elements.closeInventory.addEventListener('click', () => closePopup(elements.inventoryPopup));
            elements.closeAchievement.addEventListener('click', () => closePopup(elements.achievementPopup));
            elements.closeSettings.addEventListener('click', () => closePopup(elements.settingsPopup));

            // ä¸–ç•Œè§‚å¼¹çª—å¤–éƒ¨ç‚¹å‡»å…³é—­
            elements.worldviewPopup.addEventListener('click', (e) => {
                if (e.target === elements.worldviewPopup) {
                    closePopup(elements.worldviewPopup);
                }
            });

            // éŸ³æ•ˆå¼€å…³
            elements.soundToggle.addEventListener('click', () => {
                gameState.soundEnabled = !gameState.soundEnabled;
                elements.soundToggle.textContent = gameState.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
                elements.soundEnabled.checked = gameState.soundEnabled;
            });

            // æ€§èƒ½æ¨¡å¼å¼€å…³
            elements.performanceMode.addEventListener('change', (e) => {
                gameState.performanceMode = e.target.checked;
                if (gameState.performanceMode) {
                    reduceParticles();
                } else {
                    createParticles();
                }
            });

            // éŸ³æ•ˆå¼€å…³
            elements.soundEnabled.addEventListener('change', (e) => {
                gameState.soundEnabled = e.target.checked;
                elements.soundToggle.textContent = gameState.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
            });

            // å¯¼å‡ºå­˜æ¡£
            elements.exportSave.addEventListener('click', () => {
                const saveData = JSON.stringify(getCurrentSaveData(), null, 2);
                navigator.clipboard.writeText(saveData).then(() => {
                    showNotification("å¯¼å‡ºæˆåŠŸ", "å­˜æ¡£æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
                }).catch(() => {
                    // å¦‚æœå‰ªè´´æ¿APIä¸å¯ç”¨ï¼Œæ˜¾ç¤ºæ–‡æœ¬è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
                    const textArea = document.createElement('textarea');
                    textArea.value = saveData;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification("å¯¼å‡ºæˆåŠŸ", "å­˜æ¡£æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
                });
            });

            // å¯¼å…¥å­˜æ¡£
            elements.importSave.addEventListener('click', () => {
                const saveData = prompt("è¯·ç²˜è´´å­˜æ¡£æ•°æ®:");
                if (saveData) {
                    try {
                        const parsedData = JSON.parse(saveData);
                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (parsedData.player && parsedData.inventory) {
                            // ä¿å­˜åˆ°å½“å‰æ§½ä½
                            const currentSaveData = getSaveData();
                            currentSaveData[1] = parsedData;
                            saveGameData(currentSaveData);

                            // åŠ è½½å­˜æ¡£
                            loadGameFromSlot(1);
                            showNotification("å¯¼å…¥æˆåŠŸ", "å­˜æ¡£æ•°æ®å·²å¯¼å…¥");
                        } else {
                            alert("å­˜æ¡£æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼");
                        }
                    } catch (e) {
                        alert("å­˜æ¡£æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼");
                    }
                }
            });

            // é‡ç½®æ¸¸æˆ
            elements.resetGame.addEventListener('click', () => {
                if (confirm("ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼")) {
                    localStorage.removeItem('immortalSaveSlots');
                    localStorage.removeItem('immortalGameSave');
                    location.reload();
                }
            });
        }

        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(soundName) {
            if (gameState.soundEnabled && soundEffects[soundName]) {
                soundEffects[soundName].currentTime = 0;
                soundEffects[soundName].play().catch(e => {
                    // å¿½ç•¥è‡ªåŠ¨æ’­æ”¾é™åˆ¶é”™è¯¯
                });
            }
        }

        // æ˜¾ç¤ºå¼¹çª—
        function showPopup(popup) {
            popup.classList.add('active');
        }

        // å…³é—­å¼¹çª—
        function closePopup(popup) {
            popup.classList.remove('active');
        }

        // å¤„ç†ç©å®¶é€‰æ‹©
        function handleChoice(choice) {
            // å¢åŠ äº‹ä»¶è®¡æ•°
            gameState.eventCount++;

            let newNarrative = "";
            let newChoices = [];

            switch(choice) {
                case 1:
                    newNarrative = "ä½ ç›˜è†è€Œåï¼Œå°è¯•æ„Ÿåº”å‘¨å›´çš„å¤©åœ°çµæ°”ã€‚æ¸æ¸åœ°ï¼Œä½ æ„Ÿè§‰åˆ°ä¸€ä¸ä¸æ¸©æš–çš„æ°”æµä»å››é¢å…«æ–¹æ±‡èšè€Œæ¥ï¼Œç¼“ç¼“æ¸—å…¥ä½ çš„ç»è„‰ã€‚ä½ çš„çµåŠ›ä¼¼ä¹å¢é•¿äº†ä¸€äº›ã€‚";
                    newChoices = [
                        "ç»§ç»­æ„Ÿåº”çµæ°”",
                        "å°è¯•å¼•å¯¼çµæ°”è¿è½¬å‘¨å¤©",
                        "åœæ­¢ä¿®ç‚¼ï¼ŒæŸ¥çœ‹èº«ä½“çŠ¶å†µ"
                    ];
                    gameState.player.mana += 10;
                    gameState.player.cultivation += 15;
                    gameState.player.karma.push("æ„Ÿåº”å¤©åœ°çµæ°”");
                    break;
                case 2:
                    newNarrative = "ä½ èµ·èº«æ¢ç´¢å‘¨å›´ç¯å¢ƒã€‚åœ¨æºªè¾¹å‘ç°äº†å‡ æ ªæ•£å‘ç€å¾®å¼±çµå…‰çš„è‰è¯ï¼Œçœ‹èµ·æ¥åƒæ˜¯ä¼ è¯´ä¸­çš„æ­¢è¡€è‰ã€‚è¿œå¤„ä¼¼ä¹æœ‰ä¸€åº§å¤è€çš„é“è§‚ã€‚";
                    newChoices = [
                        "é‡‡é›†æ­¢è¡€è‰",
                        "å‰å¾€é“è§‚æ¢æŸ¥",
                        "è¿”å›åŸå¤„ç»§ç»­ä¿®ç‚¼"
                    ];
                    gameState.player.karma.push("æ¢ç´¢å‘¨å›´ç¯å¢ƒ");
                    gameState.player.explorationCount++;

                    // éšæœºè·å¾—ææ–™
                    if (Math.random() < 0.5) {
                        gameState.inventory.materials["çµæ°”æ¶²"].count += 1;
                        showNotification("è·å¾—ææ–™", "è·å¾—äº†çµæ°”æ¶²x1");
                    }
                    break;
                case 3:
                    newNarrative = "ä½ é™åè°ƒæ¯ï¼Œæ„Ÿå—ä½“å†…çš„å˜åŒ–ã€‚ä½ å‘ç°ä¸¹ç”°å¤„æœ‰ä¸€ä¸å¾®å¼±çš„æ°”æ„Ÿï¼Œéšç€ä½ çš„å‘¼å¸ç¼“ç¼“æµè½¬ã€‚è¿™åº”è¯¥å°±æ˜¯ä¿®çœŸè€…æ‰€è¯´çš„'çœŸæ°”'äº†ã€‚";
                    newChoices = [
                        "å°è¯•å¼•å¯¼çœŸæ°”è¿è½¬",
                        "ç»§ç»­é™åæ„Ÿæ‚Ÿ",
                        "åœæ­¢è°ƒæ¯ï¼Œå°è¯•å…¶ä»–æ–¹æ³•"
                    ];
                    gameState.player.health += 5;
                    gameState.player.dao += 1;
                    gameState.player.karma.push("é™åè°ƒæ¯");
                    break;
            }

            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            gameState.narrative.current = newNarrative;
            gameState.narrative.choices = newChoices;

            // æ£€æŸ¥æ˜¯å¦å¯çªç ´
            checkBreakthrough();

            // æ£€æŸ¥éšæœºäº‹ä»¶
            checkRandomEvent();

            // æ£€æŸ¥æˆå°±
            checkAchievements();

            // æ›´æ–°UI
            updateUI();

            // åˆ›å»ºç²’å­æ•ˆæœ
            createChoiceParticles();

            // å­˜æ¡£
            saveGame();
        }

        // å¤„ç†ç©å®¶è¡ŒåŠ¨
        function handleAction(action, target) {
            gameState.eventCount++;

            let newNarrative = "";
            let newChoices = [];

            switch(action) {
                case 'cultivate':
                    newNarrative = "ä½ å¯»å¾—ä¸€å¤„çµæ°”å……è£•ä¹‹åœ°ï¼Œå¼€å§‹æ‰“åä¿®ç‚¼ã€‚éšç€å‘¼å¸çš„èŠ‚å¥ï¼Œå‘¨å›´çš„çµæ°”ç¼“ç¼“æµå…¥ä½ çš„ç»è„‰ï¼Œè½¬åŒ–ä¸ºç²¾çº¯çš„çµåŠ›ã€‚ä½ çš„ä¿®ä¸ºæœ‰æ‰€æå‡ã€‚";
                    newChoices = [
                        "ç»§ç»­ä¿®ç‚¼",
                        "å°è¯•æ–°çš„ä¿®ç‚¼æ³•é—¨",
                        "ä¼‘æ¯ç‰‡åˆ»"
                    ];
                    gameState.player.cultivation += 20;
                    gameState.player.mana -= 15;
                    gameState.player.life += 1;
                    gameState.player.karma.push("æ‰“åä¿®ç‚¼");
                    gameState.player.cultivationCount++;
                    createCultivateParticles(target);
                    break;
                case 'explore':
                    newNarrative = "ä½ å¼€å§‹åœ¨ä¿®çœŸç•Œæ¸¸å†æ¢ç´¢ã€‚åœ¨ä¸€å¤„å±±è°·ä¸­ï¼Œä½ å‘ç°äº†ä¸€ä¸ªéšè”½çš„æ´ç©´ï¼Œæ´å£æ•£å‘ç€å¾®å¼±çš„çµæ°”æ³¢åŠ¨ã€‚";
                    newChoices = [
                        "è¿›å…¥æ´ç©´æ¢æŸ¥",
                        "åœ¨æ´å£å¸ƒç½®è­¦æˆ’é˜µæ³•",
                        "ç¦»å¼€æ­¤åœ°ï¼Œç»§ç»­æ¢ç´¢"
                    ];
                    gameState.player.life += 3;
                    gameState.player.karma.push("æ¢ç´¢å¯»å®");
                    gameState.player.explorationCount++;

                    // éšæœºè·å¾—ç‰©å“
                    const randomItem = Math.random();
                    if (randomItem < 0.3) {
                        gameState.inventory.potions["æ­¢è¡€è‰"].count += 2;
                        showNotification("è·å¾—ç‰©å“", "è·å¾—äº†æ­¢è¡€è‰x2");
                    } else if (randomItem < 0.5) {
                        gameState.inventory.materials["å¦–å…½å†…ä¸¹"].count += 1;
                        showNotification("è·å¾—ç‰©å“", "è·å¾—äº†å¦–å…½å†…ä¸¹x1");
                    }

                    createExploreParticles(target);
                    break;
                case 'alchemy':
                    // ç‚¼åˆ¶ä¸¹è¯é€»è¾‘ - æ¶ˆè€—15çµåŠ›ï¼Œ50%æ¦‚ç‡æˆåŠŸ
                    const alchemySuccess = Math.random() < (0.5 + gameState.player.luck * 0.02);
                    gameState.player.mana -= 15;

                    if (alchemySuccess) {
                        // æˆåŠŸç‚¼åˆ¶ç‚¼æ°”æ•£
                        gameState.inventory.potions["ç‚¼æ°”æ•£"].count += 1;
                        newNarrative = "ä¸¹è¯ç‚¼åˆ¶æˆåŠŸï¼ä½ æˆåŠŸç‚¼åˆ¶å‡ºäº†ä¸€é¢—ç‚¼æ°”æ•£ã€‚";

                        // è§£é”æˆå°±
                        if (!achievements["first_alchemy"].achieved) {
                            unlockAchievement("first_alchemy");
                        }
                    } else {
                        newNarrative = "ç‚¼ä¸¹è¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€äº›å¤±è¯¯ï¼Œä¸¹è¯ç‚¼åˆ¶å¤±è´¥ï¼Œåªæ¶ˆè€—äº†çµåŠ›ã€‚ä¸‹æ¬¡éœ€è¦æ›´åŠ ä¸“æ³¨ã€‚";
                    }

                    newChoices = [
                        "ç»§ç»­ç‚¼ä¸¹",
                        "ç ”ç©¶æ–°çš„ä¸¹æ–¹",
                        "ä¼‘æ¯æ¢å¤çµåŠ›"
                    ];
                    gameState.player.karma.push("ç‚¼åˆ¶ä¸¹è¯");
                    createActionParticles(target);
                    break;
                case 'mission':
                    // å®—é—¨ä»»åŠ¡é€»è¾‘ - æ¶ˆè€—10æ°”è¡€ï¼Œæå‡25ä¿®ä¸ºï¼Œå¢åŠ 2å¯¿å…ƒ
                    gameState.player.health -= 10;
                    gameState.player.cultivation += 25;
                    gameState.player.life += 2;

                    newNarrative = "ä½ å®Œæˆäº†ä¸€é¡¹å®—é—¨ä»»åŠ¡ï¼Œè™½ç„¶æ¶ˆè€—äº†ä¸€äº›æ°”è¡€ï¼Œä½†ä¿®ä¸ºå¾—åˆ°äº†æ˜¾è‘—æå‡ï¼Œå¯¿å…ƒä¹Ÿæœ‰æ‰€å¢åŠ ã€‚";
                    newChoices = [
                        "æ¥å–æ–°ä»»åŠ¡",
                        "ä¼‘æ¯æ¢å¤æ°”è¡€",
                        "ç”¨å¥–åŠ±å…‘æ¢èµ„æº"
                    ];
                    gameState.player.karma.push("æ¥å–å®—é—¨ä»»åŠ¡");
                    createActionParticles(target);
                    break;
                case 'breakthrough':
                    // çªç ´æ“ä½œ
                    handleBreakthroughAction(target);
                    return; // æå‰è¿”å›ï¼Œå› ä¸ºçªç ´æœ‰ç‰¹æ®Šå¤„ç†
            }

            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            gameState.narrative.current = newNarrative;
            gameState.narrative.choices = newChoices;

            // æ£€æŸ¥æ˜¯å¦å¯çªç ´
            checkBreakthrough();

            // æ£€æŸ¥éšæœºäº‹ä»¶
            checkRandomEvent();

            // æ£€æŸ¥æˆå°±
            checkAchievements();

            // æ›´æ–°UI
            updateUI();

            // å­˜æ¡£
            saveGame();
        }

        // å¤„ç†çªç ´æ“ä½œ
        function handleBreakthroughAction(target) {
            showLoading("breakthrough");

            setTimeout(() => {
                let newNarrative = "";
                let newChoices = [];

                if (gameState.player.cultivation >= gameState.player.breakthrough) {
                    const currentRealm = gameState.player.realm;
                    const nextRealm = realmSystem[currentRealm].next;

                    if (nextRealm) {
                        // æ£€æŸ¥é“å¿ƒè¦æ±‚
                        const daoRequired = realmSystem[nextRealm].daoRequired;
                        if (gameState.player.dao >= daoRequired) {
                            if (currentRealm === "å‡¡äºº" && gameState.inventory.potions["ç­‘åŸºä¸¹"].count > 0) {
                                // çªç ´æˆåŠŸ
                                gameState.player.realm = nextRealm;
                                gameState.player.stage = 0;
                                gameState.player.cultivation = 0;
                                gameState.player.breakthrough = realmSystem[nextRealm].breakthroughExp;
                                gameState.player.maxHealth = realmSystem[nextRealm].maxHealth;
                                gameState.player.health = realmSystem[nextRealm].maxHealth;
                                gameState.player.maxMana = realmSystem[nextRealm].maxMana;
                                gameState.player.mana = realmSystem[nextRealm].maxMana;
                                gameState.player.maxLife = realmSystem[nextRealm].maxLife;
                                gameState.inventory.potions["ç­‘åŸºä¸¹"].count--;

                                newNarrative = `ğŸ‰ æ­å–œï¼ä½ æˆåŠŸçªç ´åˆ°${nextRealm}æœŸï¼ä½ æ„Ÿè§‰åˆ°ä½“å†…çµåŠ›æš´æ¶¨ï¼Œå¯¿å…ƒä¹Ÿæœ‰æ‰€å¢åŠ ã€‚`;
                                newChoices = [
                                    "å·©å›ºå½“å‰å¢ƒç•Œ",
                                    "å°è¯•æ–°çš„ç¥é€š",
                                    "å¤–å‡ºæ¸¸å†"
                                ];
                                gameState.player.karma.push(`çªç ´è‡³${nextRealm}æœŸ`);

                                // è§£é”æˆå°±
                                if (nextRealm === "ç‚¼æ°”") {
                                    unlockAchievement("first_breakthrough");
                                }

                                // æ˜¾ç¤ºçªç ´ç‰¹æ•ˆ
                                createBreakthroughEffect();
                            } else if (currentRealm !== "å‡¡äºº") {
                                // å…¶ä»–å¢ƒç•Œçªç ´
                                gameState.player.realm = nextRealm;
                                gameState.player.stage = 0;
                                gameState.player.cultivation = 0;
                                gameState.player.breakthrough = realmSystem[nextRealm].breakthroughExp;
                                gameState.player.maxHealth = realmSystem[nextRealm].maxHealth;
                                gameState.player.health = realmSystem[nextRealm].maxHealth;
                                gameState.player.maxMana = realmSystem[nextRealm].maxMana;
                                gameState.player.mana = realmSystem[nextRealm].maxMana;
                                gameState.player.maxLife = realmSystem[nextRealm].maxLife;

                                newNarrative = `ğŸ‰ æ­å–œï¼ä½ æˆåŠŸçªç ´åˆ°${nextRealm}æœŸï¼ä½ æ„Ÿè§‰åˆ°ä½“å†…çµåŠ›æš´æ¶¨ï¼Œå¯¿å…ƒä¹Ÿæœ‰æ‰€å¢åŠ ã€‚`;
                                newChoices = [
                                    "å·©å›ºå½“å‰å¢ƒç•Œ",
                                    "å°è¯•æ–°çš„ç¥é€š",
                                    "å¤–å‡ºæ¸¸å†"
                                ];
                                gameState.player.karma.push(`çªç ´è‡³${nextRealm}æœŸ`);

                                // æ˜¾ç¤ºçªç ´ç‰¹æ•ˆ
                                createBreakthroughEffect();
                            } else {
                                newNarrative = "çªç ´ç­‘åŸºæœŸéœ€è¦ç­‘åŸºä¸¹ï¼Œä½ è¿˜æ²¡æœ‰å‡†å¤‡å¥½ã€‚";
                                newChoices = [
                                    "ç»§ç»­ä¿®ç‚¼",
                                    "å¯»æ‰¾ç­‘åŸºä¸¹ææ–™",
                                    "è¯·æ•™ä»–äººçªç ´ç»éªŒ"
                                ];
                            }
                        } else {
                            newNarrative = `ä½ çš„é“å¿ƒä¸è¶³ï¼Œæ— æ³•çªç ´åˆ°${nextRealm}æœŸã€‚éœ€è¦é“å¿ƒè¾¾åˆ°${daoRequired}ç‚¹ã€‚`;
                            newChoices = [
                                "ç»§ç»­ä¿®ç‚¼",
                                "æå‡é“å¿ƒ",
                                "è¯·æ•™ä»–äººçªç ´ç»éªŒ"
                            ];
                        }
                    } else {
                        newNarrative = "ä½ å·²ç»è¾¾åˆ°æœ€é«˜å¢ƒç•Œï¼Œæ— æ³•ç»§ç»­çªç ´ã€‚";
                        newChoices = [
                            "å·©å›ºå½“å‰å¢ƒç•Œ",
                            "æ¢ç´¢æ›´é«˜å±‚æ¬¡çš„å¥¥ç§˜",
                            "ä¼ æˆç»éªŒç»™åè¾ˆ"
                        ];
                    }
                } else {
                    newNarrative = "ä½ çš„ä¿®ä¸ºå°šæœªè¾¾åˆ°çªç ´çš„è¦æ±‚ï¼Œå¼ºè¡Œçªç ´å¯èƒ½å¯¼è‡´çµåŠ›åå™¬ã€‚å»ºè®®ç»§ç»­ç§¯ç´¯ä¿®ä¸ºã€‚";
                    newChoices = [
                        "ç»§ç»­ä¿®ç‚¼",
                        "å¯»æ‰¾æå‡ä¿®ä¸ºçš„ä¸¹è¯",
                        "è¯·æ•™ä»–äººçªç ´ç»éªŒ"
                    ];
                }
                gameState.player.karma.push("å°è¯•çªç ´å¢ƒç•Œ");

                // æ›´æ–°æ¸¸æˆçŠ¶æ€
                gameState.narrative.current = newNarrative;
                gameState.narrative.choices = newChoices;

                // æ£€æŸ¥æ˜¯å¦å¯çªç ´
                checkBreakthrough();

                // æ£€æŸ¥éšæœºäº‹ä»¶
                checkRandomEvent();

                // æ£€æŸ¥æˆå°±
                checkAchievements();

                // æ›´æ–°UI
                updateUI();

                // éšè—åŠ è½½
                hideLoading();

                createActionParticles(target);

                // å­˜æ¡£
                saveGame();
            }, 800);
        }

        // å¤„ç†è‡ªåŠ¨ä¿®ç‚¼
        function handleAutoCultivate(target) {
            let count = 10;
            const autoCultivate = () => {
                if (count <= 0) return;
                count--;

                // æ‰§è¡Œä¿®ç‚¼é€»è¾‘
                gameState.player.cultivation += 20 + gameState.player.talent * 3;
                gameState.player.mana -= 15;
                gameState.player.life += 1;
                gameState.player.karma.push("è‡ªåŠ¨ä¿®ç‚¼");
                gameState.player.cultivationCount++;

                // æ›´æ–°UI
                updateUI();
                createCultivateParticles(target);

                // ç»§ç»­ä¸‹ä¸€æ¬¡ï¼Œé—´éš”100ms
                setTimeout(autoCultivate, 100);
            };
            autoCultivate();

            // æ£€æŸ¥æˆå°±
            checkAchievements();

            // å­˜æ¡£
            saveGame();
        }

        // æ£€æŸ¥éšæœºäº‹ä»¶
        function checkRandomEvent() {
            // æ¯3æ¬¡æ“ä½œè§¦å‘ä¸€æ¬¡éšæœºäº‹ä»¶
            if (gameState.eventCount % 3 === 0) {
                const events = [
                    {
                        name: "çµæ°”æš´åŠ¨",
                        description: "å‘¨å›´çš„çµæ°”çªç„¶å˜å¾—å¼‚å¸¸æ´»è·ƒï¼Œä¿®ç‚¼æ•ˆæœå¤§å¹…æå‡ï¼",
                        effect: () => {
                            gameState.player.cultivation += 30;
                            showNotification("çµæ°”æš´åŠ¨", "ä¿®ä¸ºå¢é€Ÿä¸´æ—¶+30%");
                        }
                    },
                    {
                        name: "å¦–å…½è¢­æ‰°",
                        description: "ä¸€åªå¦–å…½çªç„¶å‡ºç°å¹¶å‘ä½ å‘èµ·æ”»å‡»ï¼",
                        effect: () => {
                            gameState.player.health -= 20;
                            gameState.inventory.materials["å¦–å…½å†…ä¸¹"].count += 1;
                            showNotification("å¦–å…½è¢­æ‰°", "å‡»è´¥å¦–å…½ï¼Œè·å¾—å¦–å…½å†…ä¸¹x1");
                        }
                    },
                    {
                        name: "ç§˜å¢ƒå¼€å¯",
                        description: "é™„è¿‘å‡ºç°äº†ä¸€ä¸ªç¥ç§˜çš„ç§˜å¢ƒå…¥å£ï¼Œé‡Œé¢ä¼¼ä¹æœ‰çç¨€å®ç‰©ã€‚",
                        effect: () => {
                            gameState.inventory.potions["ç­‘åŸºä¸¹"].count += 1;
                            showNotification("ç§˜å¢ƒå¼€å¯", "æ¢ç´¢ç§˜å¢ƒï¼Œè·å¾—ç­‘åŸºä¸¹x1");
                        }
                    }
                ];

                const randomEvent = events[Math.floor(Math.random() * events.length)];
                randomEvent.effect();

                // æ›´æ–°å™äº‹
                gameState.narrative.current = `ã€éšæœºäº‹ä»¶ã€‘${randomEvent.name}ï¼š${randomEvent.description}`;
                gameState.narrative.choices = [
                    "ç»§ç»­æ¢ç´¢",
                    "è¿”å›å®‰å…¨åŒºåŸŸ",
                    "å¯»æ±‚å¸®åŠ©"
                ];
            }
        }

        // æ£€æŸ¥æˆå°±
        function checkAchievements() {
            // æ£€æŸ¥ä¿®ç‚¼è¾¾äººæˆå°±
            if (gameState.player.cultivationCount >= 10 && !achievements["cultivation_master"].achieved) {
                unlockAchievement("cultivation_master");
            }

            // æ£€æŸ¥æ¢ç´¢ä¸“å®¶æˆå°±
            if (gameState.player.explorationCount >= 10 && !achievements["exploration_expert"].achieved) {
                unlockAchievement("exploration_expert");
            }
        }

        // æ£€æŸ¥æ˜¯å¦å¯çªç ´å¢ƒç•Œ
        function checkBreakthrough() {
            if (gameState.player.cultivation >= gameState.player.breakthrough) {
                // å¯ä»¥çªç ´
                elements.breakthroughBtn.classList.add('new-feature');
            }
        }

        // è§£é”æˆå°±
        function unlockAchievement(achievementId) {
            if (achievements[achievementId] && !achievements[achievementId].achieved) {
                achievements[achievementId].achieved = true;
                gameState.player.achievements.push(achievementId);

                // åº”ç”¨å¥–åŠ±
                const reward = achievements[achievementId].reward;
                if (reward.cultivation) {
                    gameState.player.cultivation += reward.cultivation;
                }
                if (reward.talent) {
                    gameState.player.talent += reward.talent;
                }

                // æ˜¾ç¤ºé€šçŸ¥
                showNotification("æˆå°±è§£é”", `${achievements[achievementId].name}ï¼š${achievements[achievementId].description}`);

                // å­˜æ¡£
                saveGame();
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(title, description) {
            elements.notificationTitle.textContent = title;
            elements.notificationDesc.textContent = description;
            elements.notification.classList.add('show');

            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }

        // æ˜¾ç¤ºåŠ è½½ç•Œé¢
        function showLoading(type = "default") {
            if (gameState.loading) return;
            gameState.loading = true;

            elements.loadingScreen.style.display = 'flex';
            elements.loadingFill.style.width = '0%';

            // æŒ‰æ“ä½œç±»å‹ä¿®æ”¹åŠ è½½æ–‡å­—
            const loadingTexts = {
                default: "å¤©é“æ¼”ç®—ä¸­...",
                breakthrough: "çµæ°”æ±‡èšä¸­...",
                alchemy: "ä¸¹ç«æ·¬ç‚¼ä¸­...",
                explore: "ç§˜å¢ƒæ¢æŸ¥ä¸­..."
            };
            elements.loadingText.textContent = loadingTexts[type] || loadingTexts.default;

            // æ¨¡æ‹ŸçœŸå®è¿›åº¦ï¼ˆéåŒ€é€Ÿï¼‰
            setTimeout(() => elements.loadingFill.style.width = '30%', 100);
            setTimeout(() => elements.loadingFill.style.width = '65%', 300);
            setTimeout(() => elements.loadingFill.style.width = '85%', 500);
        }

        // éšè—åŠ è½½ç•Œé¢
        function hideLoading() {
            elements.loadingFill.style.width = '100%';
            setTimeout(() => {
                elements.loadingScreen.style.display = 'none';
                gameState.loading = false;
            }, 500);
        }

        // åˆ›å»ºèƒŒæ™¯ç²’å­æ•ˆæœ
        function createParticles() {
            const overlay = document.querySelector('.ui-overlay');
            overlay.innerHTML = '';

            // æ£€æµ‹è®¾å¤‡æ€§èƒ½
            const isLowPerformance = window.innerWidth < 375 || window.devicePixelRatio < 2;
            const particleCount = isLowPerformance ? 10 : (gameState.performanceMode ? 15 : 30);

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';

                // éšæœºå¤§å°ã€ä½ç½®å’Œé¢œè‰²
                const size = Math.random() * 4 + 1;
                const left = Math.random() * 100;
                const top = Math.random() * 100;
                const color = `rgba(${100 + Math.random() * 155}, ${80 + Math.random() * 100}, ${180 + Math.random() * 75}, ${0.3 + Math.random() * 0.4})`;

                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${left}%`;
                particle.style.top = `${top}%`;
                particle.style.background = color;

                // éšæœºåŠ¨ç”»
                const duration = 20 + Math.random() * 30;
                const delay = Math.random() * 5;

                particle.style.animation = `float ${duration}s ${delay}s infinite linear`;

                overlay.appendChild(particle);
            }

            // æ·»åŠ CSSåŠ¨ç”»
            if (!document.querySelector('#particle-animation')) {
                const style = document.createElement('style');
                style.id = 'particle-animation';
                style.textContent = `
                    @keyframes float {
                        0% { transform: translate(0, 0) rotate(0deg); }
                        25% { transform: translate(${Math.random() * 20 - 10}px, ${Math.random() * 20 - 10}px) rotate(90deg); }
                        50% { transform: translate(${Math.random() * 30 - 15}px, ${Math.random() * 30 - 15}px) rotate(180deg); }
                        75% { transform: translate(${Math.random() * 20 - 10}px, ${Math.random() * 20 - 10}px) rotate(270deg); }
                        100% { transform: translate(0, 0) rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // å‡å°‘ç²’å­æ•°é‡ï¼ˆæ€§èƒ½æ¨¡å¼ï¼‰
        function reduceParticles() {
            const particles = document.querySelectorAll('.particle');
            if (particles.length > 15) {
                for (let i = 15; i < particles.length; i++) {
                    particles[i].remove();
                }
            }
        }

        // åˆ›å»ºé€‰æ‹©ç²’å­æ•ˆæœ
        function createChoiceParticles() {
            const buttons = document.querySelectorAll('.choice-btn');
            buttons.forEach(button => {
                for (let i = 0; i < 5; i++) {
                    createFloatingText(button, "+1 ä¿®ä¸º", 'cultivation');
                }
            });
        }

        // åˆ›å»ºä¿®ç‚¼ç²’å­æ•ˆæœ
        function createCultivateParticles(button) {
            for (let i = 0; i < 6; i++) {
                const text = `+${15 + gameState.player.talent * 2} ä¿®ä¸º`;
                createFloatingText(button, text, 'cultivation');
            }
        }

        // åˆ›å»ºæ¢ç´¢ç²’å­æ•ˆæœ
        function createExploreParticles(button) {
            for (let i = 0; i < 4; i++) {
                const text = `+${1 + gameState.player.luck * 0.5} ç¦ç¼˜`;
                createFloatingText(button, text, 'luck');
            }
        }

        // åˆ›å»ºé€šç”¨è¡ŒåŠ¨ç²’å­æ•ˆæœ
        function createActionParticles(button) {
            for (let i = 0; i < 8; i++) {
                createFloatingText(button, "+5 çµåŠ›", 'mana');
            }
        }

        // åˆ›å»ºçªç ´ç‰¹æ•ˆ
        function createBreakthroughEffect() {
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');

            // è®¾ç½®canvaså°ºå¯¸
            resizeCanvas();

            // çªç ´å…‰æ•ˆ
            let radius = 0;
            const maxRadius = Math.max(canvas.width, canvas.height) * 0.8;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            function drawBreakthrough() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // ç»˜åˆ¶å…‰æ™•
                const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                gradient.addColorStop(0, 'rgba(180, 120, 255, 0.8)');
                gradient.addColorStop(0.5, 'rgba(140, 80, 220, 0.4)');
                gradient.addColorStop(1, 'rgba(100, 60, 180, 0)');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.fill();

                radius += 5;

                if (radius < maxRadius) {
                    requestAnimationFrame(drawBreakthrough);
                } else {
                    // ç‰¹æ•ˆç»“æŸï¼Œæ˜¾ç¤ºæ–‡å­—
                    showBreakthroughText();
                }
            }

            function showBreakthroughText() {
                const text = "å¢ƒç•Œçªç ´ï¼";
                ctx.font = "bold 48px SimSun, å®‹ä½“";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                // æ–‡å­—å‘å…‰æ•ˆæœ
                ctx.shadowColor = 'var(--primary-color)';
                ctx.shadowBlur = 20;
                ctx.fillStyle = 'var(--secondary-color)';
                ctx.fillText(text, centerX, centerY);

                ctx.shadowBlur = 0;

                // 3ç§’åæ¸…é™¤æ–‡å­—
                setTimeout(() => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }, 3000);
            }

            drawBreakthrough();
        }

        // åˆ›å»ºæµ®åŠ¨æ–‡å­—æ•ˆæœ
        function createFloatingText(element, text, type) {
            const rect = element.getBoundingClientRect();
            const gameContainer = document.getElementById('game-container');
            const gameRect = gameContainer.getBoundingClientRect();

            const floatingText = document.createElement('div');
            floatingText.className = `floating-text ${type}`;
            floatingText.textContent = text;
            floatingText.style.left = `${rect.left - gameRect.left + rect.width / 2}px`;
            floatingText.style.top = `${rect.top - gameRect.top}px`;

            gameContainer.appendChild(floatingText);

            // ä½¿ç”¨CSSè¿‡æ¸¡
            setTimeout(() => {
                floatingText.style.opacity = '1';
                floatingText.style.transform = 'translateY(-30px) rotate(5deg)';
            }, 10);

            // ç§»é™¤å…ƒç´ 
            setTimeout(() => {
                floatingText.style.opacity = '0';
                floatingText.style.transform = 'translateY(-60px) rotate(10deg)';
                setTimeout(() => {
                    if (floatingText.parentNode) {
                        gameContainer.removeChild(floatingText);
                    }
                }, 500);
            }, 1500);
        }

        // åˆå§‹åŒ–Canvas
        function initCanvas() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        // è°ƒæ•´Canvaså¤§å°
        function resizeCanvas() {
            const canvas = document.getElementById('game-canvas');
            const container = document.querySelector('.scene-container');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            // é‡æ–°ç»˜åˆ¶èƒŒæ™¯
            const ctx = canvas.getContext('2d');
            drawBackground(ctx, canvas.width, canvas.height);
        }

        // ç»˜åˆ¶èƒŒæ™¯ - ä¿®å¤ç‰ˆ
        function drawBackground(ctx, width, height) {
            // ç»˜åˆ¶æ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#1a1a3a');
            gradient.addColorStop(1, '#0a0a1a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            // ç»˜åˆ¶è¿œå±±
            ctx.fillStyle = 'rgba(30, 20, 50, 0.7)';
            ctx.beginPath();
            ctx.moveTo(0, height * 0.6);
            ctx.bezierCurveTo(width * 0.2, height * 0.5, width * 0.4, height * 0.7, width, height * 0.6);
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.closePath();
            ctx.fill();

            // ç»˜åˆ¶è¿‘å±±
            ctx.fillStyle = 'rgba(40, 30, 70, 0.8)';
            ctx.beginPath();
            ctx.moveTo(0, height * 0.7);
            ctx.bezierCurveTo(width * 0.3, height * 0.6, width * 0.6, height * 0.8, width, height * 0.7);
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.closePath();
            ctx.fill();

            // ç»˜åˆ¶æœˆäº®
            ctx.fillStyle = 'rgba(240, 240, 200, 0.3)';
            ctx.beginPath();
            ctx.arc(width * 0.8, height * 0.2, 40, 0, Math.PI * 2);
            ctx.fill();

            // ç»˜åˆ¶æ˜Ÿå…‰
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            for (let i = 0; i < 30; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height * 0.6;
                const size = Math.random() * 1.5 + 0.5;

                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // è·å–å½“å‰å­˜æ¡£æ•°æ®
        function getCurrentSaveData() {
            return {
                player: gameState.player,
                inventory: gameState.inventory,
                narrative: gameState.narrative,
                achievements: achievements,
                eventCount: gameState.eventCount,
                lastSaveTime: Date.now()
            };
        }

        // ä¿å­˜æ¸¸æˆ
        function saveGame() {
            if (gameState.saving) return;
            gameState.saving = true;

            const saveData = getSaveData();
            saveData[1] = getCurrentSaveData();
            saveGameData(saveData);

            // æ˜¾ç¤ºå­˜æ¡£æç¤º
            elements.saveIndicator.classList.add('show');
            setTimeout(() => elements.saveIndicator.classList.remove('show'), 1500);

            // 1ç§’åå…è®¸å†æ¬¡å­˜æ¡£
            setTimeout(() => gameState.saving = false, 1000);
        }

        // å¯åŠ¨æ¸¸æˆ
        window.addEventListener('load', initGame);
    </script>
</body>

</html>
